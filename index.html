<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Bedroom Layout Planner – v12.2</title>
  <style>
    /* ——— Layout & basic UI ——— */
    *{box-sizing:border-box}
    body{font-family:system-ui,sans-serif;display:flex;gap:1.5rem;padding:1rem;background:#f8fafc}
    canvas{border-radius:.5rem;box-shadow:0 2px 8px rgba(0,0,0,.1);touch-action:none;user-select:none}
    #panel{width:260px;display:flex;flex-direction:column;gap:1rem}
    h2{font-size:1.1rem;margin:0;font-weight:600;color:#334155}
    ul{list-style:none;margin:0;padding:0;max-height:260px;overflow:auto;border:1px solid #e2e8f0;border-radius:.5rem}
    li{padding:.35rem .5rem;cursor:pointer;border-bottom:1px solid #e2e8f0;display:flex;flex-direction:column;gap:.1rem}
    li:last-child{border-bottom:none}
    li.active{background:#e0f2fe}
    .row{display:flex;align-items:center;gap:.5rem}
    .swatch{width:16px;height:16px;border-radius:3px;border:1px solid #cbd5e1}
    .dim{font-size:.7rem;color:#64748b;margin-left:1.5rem}
    label{display:flex;flex-direction:column;font-size:.8rem;color:#475569;gap:.25rem}
    input,button{font:inherit;padding:.25rem .5rem;border:1px solid #cbd5e1;border-radius:.35rem}
    input[type="color"]{padding:0;border:none;width:32px;height:32px}
    button{cursor:pointer;background:#e2e8f0;transition:.15s}
    button:hover{background:#cbd5e1}
    button:active{background:#94a3b8;color:#fff}
    #edit{display:none;flex-direction:column;gap:.5rem;border:1px solid #e2e8f0;border-radius:.5rem;padding:.75rem}
    #spaceInfo{font-size:.85rem;color:#0f172a;border:1px solid #e2e8f0;border-radius:.5rem;padding:.5rem;background:#f1f5f9}
    /* layer‑order arrows */
    .arrow{margin-left:auto;padding:0 4px;font-size:.8rem;background:none;border:none;cursor:pointer;color:#475569}
    .arrow:hover{color:#1e293b}
    .arrow:disabled{opacity:.3;cursor:default}
  </style>
</head>
<body>
  <!-- ── Main column (canvas & global buttons) ── -->
  <div style="display:flex;flex-direction:column;align-items:center;gap:.75rem">
    <h1 style="font-size:1.25rem;margin:0;font-weight:600">Bedroom Layout Planner v12.2<br>(12 × 10 ft room • 45 × 24 in closet)</h1>
    <canvas id="stage" width="720" height="720"></canvas>
    <div style="display:flex;gap:.75rem">
      <button id="savePng">Save PNG</button>
      <button id="saveLayout">Save Layout</button>
      <button id="loadLayout">Load Layout</button>
      <input type="file" id="fileInput" accept="application/json" style="display:none" />
    </div>
  </div>

  <!-- ── Side panel ── -->
  <div id="panel">
    <h2>Objects</h2>
    <ul id="objList"></ul>
    <button id="addObj">➕ Add Object</button>
    <div id="spaceInfo">Calculating…</div>

    <div id="edit">
      <h2 style="font-size:1rem">Edit Selected</h2>
      <label>Name <input id="nameInp"></label>
      <label>Width (in) <input id="wInp" type="number" step="0.25"></label>
      <label>Height (in) <input id="hInp" type="number" step="0.25"></label>
      <label>Color <input id="colInp" type="color"></label>
      <label>Transparency (α) <input id="alphaInp" type="range" min="0" max="1" step="0.05"></label>
      <button id="delObj" style="background:#fecaca">🗑 Delete</button>
    </div>
  </div>

<script>
/***** ── Constants & geometry ── *****/
const SCALE = 5;                     // 1 inch → 5 pixels
const ROOM_W_IN = 144, ROOM_H_IN = 120;
const CLOSET_W_IN = 45,  CLOSET_H_IN = 24;
const TOTAL_H_IN  = ROOM_H_IN + CLOSET_H_IN;
const UNIT_W = ROOM_W_IN * SCALE;
const UNIT_H = ROOM_H_IN * SCALE;
const CLOSET_W_PX = CLOSET_W_IN * SCALE;
const CLOSET_H_PX = CLOSET_H_IN * SCALE;
const CANVAS_H = TOTAL_H_IN * SCALE;
const PILLAR = 3 * SCALE;            // 3‑in pillars/trim
const LEFT_PILLAR_LEN = 50 * SCALE;  // left vertical pillar height
const MEAS_VERT_IN = 33, MEAS_HORZ_IN = 39.5;
const DOOR_W_IN = 30, DOOR_H_IN = 30;
const DOOR_W_PX = DOOR_W_IN * SCALE, DOOR_H_PX = DOOR_H_IN * SCALE;
const DOOR_X = 0, DOOR_Y = CLOSET_H_PX;

/***** ── Helper utilities ── *****/
const make = (label,w,h,x,y,color) => ({
  id: crypto.randomUUID(),
  label,
  w: w * SCALE,
  h: h * SCALE,
  x,
  y,
  color,
  angle: 0,
  alpha: 1
});
const inch = px => px / SCALE;
const dimsTxt = it => `${inch(it.w).toFixed(2).replace(/\.00$/,'')}×${inch(it.h).toFixed(2).replace(/\.00$/,'')}″`;

/***** ── Initial sample items ── *****/
let items = (() => {
  const raw = [
    {label:'Twin XL Bed', width_in:82, height_in:40, x_in:58.4, y_in:100.4, color:'#b0c4de', angle:0, alpha:1},
    {label:'Nightstand',   width_in:20, height_in:20, x_in:120.2,y_in:79.6,  color:'#deb887', angle:0, alpha:1},
    {label:'Stand Up Dresser', width_in:20, height_in:42, x_in:3.6,  y_in:98.6, color:'#ffe4b5', angle:0, alpha:1},
    {label:'Computer Chair',   width_in:27, height_in:27, x_in:106.6,y_in:45.6, color:'#a7f3d0', angle:0, alpha:0.8},
    {label:'Computer Desk',    width_in:48, height_in:23.5,x_in:93.8, y_in:24.2, color:'#77715f', angle:0, alpha:0.95},
    {label:'Stand Up Dresser V2',width_in:42,height_in:20,x_in:40.6,y_in:24.4,color:'#ffe4b5', angle:0, alpha:0.8}
  ];
  return raw.map(o => {
    const it = make(o.label,o.width_in,o.height_in,o.x_in*SCALE,o.y_in*SCALE,o.color);
    it.angle = o.angle || 0;
    it.alpha = o.alpha ?? 1;
    return it;
  });
})();

/***** ── Canvas setup & shared state ── *****/
const canvas = document.getElementById('stage');
canvas.height = CANVAS_H;
const ctx = canvas.getContext('2d');
let selected = null;
let drag = false;
let offX = 0, offY = 0;
const dims = it => (it.angle % 180 === 0 ? {w:it.w,h:it.h} : {w:it.h,h:it.w});

/***** ── Drawing routine ── *****/
function draw(){
  ctx.clearRect(0,0,UNIT_W,CANVAS_H);
  ctx.fillStyle = '#ffffff';  // solid white BG (for PNG)
  ctx.fillRect(0,0,UNIT_W,CANVAS_H);

  // closet & unusable strip
  ctx.fillStyle = '#fff';         ctx.fillRect(0,0,CLOSET_W_PX,CLOSET_H_PX);
  ctx.fillStyle = '#111827';      ctx.fillRect(CLOSET_W_PX,0,UNIT_W-CLOSET_W_PX,CLOSET_H_PX);
  ctx.setLineDash([8,6]);
  ctx.strokeStyle='#94a3b8'; ctx.lineWidth=2; ctx.strokeRect(0,0,CLOSET_W_PX,CLOSET_H_PX);
  ctx.setLineDash([]);

  // door footprint
  ctx.fillStyle='#f9fafb'; ctx.fillRect(DOOR_X,DOOR_Y,DOOR_W_PX,DOOR_H_PX);
  ctx.setLineDash([6,4]); ctx.strokeStyle='#d1d5db'; ctx.strokeRect(DOOR_X,DOOR_Y,DOOR_W_PX,DOOR_H_PX); ctx.setLineDash([]);
  ctx.fillStyle='#1e293b'; ctx.font='12px sans-serif'; ctx.textAlign='center'; ctx.textBaseline='middle';
  ctx.fillText('DOOR SPACE', DOOR_X+DOOR_W_PX/2, DOOR_Y+DOOR_H_PX/2);

  // gray pillar trims
  ctx.fillStyle='#e5e7eb';
  ctx.fillRect(0,CANVAS_H-LEFT_PILLAR_LEN,PILLAR,LEFT_PILLAR_LEN);
  ctx.fillRect(UNIT_W-PILLAR,0,PILLAR,CANVAS_H);
  ctx.fillRect(0,CANVAS_H-PILLAR,UNIT_W,PILLAR);

  // grid lines
  ctx.strokeStyle='#f3f4f6'; ctx.lineWidth=1;
  for(let x=PILLAR;x<=UNIT_W-PILLAR;x+=60){ctx.beginPath(); ctx.moveTo(x,CLOSET_H_PX); ctx.lineTo(x,CANVAS_H); ctx.stroke();}
  for(let y=CLOSET_H_PX;y<=CANVAS_H;y+=60){ctx.beginPath(); ctx.moveTo(PILLAR,y); ctx.lineTo(UNIT_W-PILLAR,y); ctx.stroke();}
  for(let x=0;x<=CLOSET_W_PX;x+=60){ctx.beginPath(); ctx.moveTo(x,0); ctx.lineTo(x,CLOSET_H_PX); ctx.stroke();}
  for(let y=0;y<=CLOSET_H_PX;y+=60){ctx.beginPath(); ctx.moveTo(0,y); ctx.lineTo(CLOSET_W_PX,y); ctx.stroke();}

  // zone labels & measurement reference
  ctx.fillStyle='#1e293b'; ctx.font='bold 16px sans-serif';
  ctx.fillText('CLOSET', CLOSET_W_PX/2, CLOSET_H_PX/2);
  ctx.fillText('BEDROOM', UNIT_W/2, CLOSET_H_PX + UNIT_H/2);
  ctx.strokeStyle='#000'; ctx.lineWidth=4;
  ctx.beginPath(); ctx.moveTo(0,CLOSET_H_PX); ctx.lineTo(MEAS_HORZ_IN*SCALE, CLOSET_H_PX); ctx.stroke();
  ctx.beginPath(); ctx.moveTo(0,CLOSET_H_PX); ctx.lineTo(0, CLOSET_H_PX + MEAS_VERT_IN*SCALE); ctx.stroke();

  // reference red bars (requested markers)
  ctx.fillStyle='#dc2626';
  ctx.fillRect(UNIT_W - PILLAR - 63, CLOSET_H_PX + 5, 60, 4);                         // top‑right bar
  ctx.fillRect(PILLAR - 2, CLOSET_H_PX + UNIT_H/2 - 30, 4, 60);                       // left‑mid bar
  ctx.fillRect(UNIT_W/2 - 30, CANVAS_H - PILLAR - 9, 60, 4);                          // bottom‑mid bar

  // draw all items (in current z‑order)
  for(const it of items){
    ctx.save();
    ctx.translate(it.x + it.w/2, it.y + it.h/2);
    ctx.rotate(it.angle * Math.PI / 180);
    ctx.globalAlpha = it.alpha;

    ctx.fillStyle = it.color;
    ctx.fillRect(-it.w/2, -it.h/2, it.w, it.h);
    ctx.strokeStyle='#475569'; ctx.lineWidth=2;
    ctx.strokeRect(-it.w/2, -it.h/2, it.w, it.h);

    ctx.fillStyle='#000'; ctx.font='12px sans-serif'; ctx.textAlign='center'; ctx.textBaseline='middle';
    const lines = [it.label, dimsTxt(it)];
    lines.forEach((ln,i)=> ctx.fillText(ln, 0, (i-(lines.length-1)/2)*14));

    ctx.restore();
  }

  updateSpace();
}

/***** ── Space calculation ── *****/
const spaceInfo = document.getElementById('spaceInfo');
function updateSpace(){
  const totalArea  = ROOM_W_IN*ROOM_H_IN + CLOSET_W_IN*CLOSET_H_IN;
  const grayArea   = (3*TOTAL_H_IN) + (3*50) + (3*ROOM_W_IN) - 18; // rough pillar/trim
  const furniture  = items.reduce((sum,it)=> sum + inch(it.w)*inch(it.h), 0);
  const free       = Math.max(0, totalArea - grayArea - furniture);
  spaceInfo.textContent = `Free space: ${(free/144).toFixed(1)} ft²  (${free.toFixed(0)} in²)`;
}

/***** ── Object list + editor ── *****/
const listEl     = document.getElementById('objList');
const editBox    = document.getElementById('edit');
const nameInp    = document.getElementById('nameInp');
const wInp       = document.getElementById('wInp');
const hInp       = document.getElementById('hInp');
const colInp     = document.getElementById('colInp');

function moveItem(idx,dir){
  const newIdx = idx + dir;
  if(newIdx < 0 || newIdx >= items.length) return;
  const [it] = items.splice(idx,1);
  items.splice(newIdx,0,it);
  refreshList(); draw();
}

function refreshList(){
  listEl.innerHTML='';
  items.forEach((it,idx)=>{
    const li = document.createElement('li');
    li.className = it === selected ? 'active' : '';

    const row = document.createElement('div'); row.className='row';
    const sw  = document.createElement('span'); sw.className='swatch'; sw.style.background = it.color; row.appendChild(sw);
    row.appendChild(document.createTextNode(it.label));

    const up = document.createElement('button');  up.textContent='↑'; up.className='arrow'; up.disabled = idx===0; up.onclick = e=>{e.stopPropagation(); moveItem(idx,-1);};
    const dn = document.createElement('button');  dn.textContent='↓'; dn.className='arrow'; dn.disabled = idx===items.length-1; dn.onclick = e=>{e.stopPropagation(); moveItem(idx,1);};
    row.appendChild(up); row.appendChild(dn);

    li.appendChild(row);
    const dim = document.createElement('span'); dim.className='dim'; dim.textContent = dimsTxt(it); li.appendChild(dim);

    li.onclick = ()=>{ selected = it; refreshList(); updateEditor(); draw(); };
    listEl.appendChild(li);
  });
}

function updateEditor(){
  if(!selected){ editBox.style.display='none'; return; }
  editBox.style.display='flex';
  nameInp.value  = selected.label;
  wInp.value     = inch(selected.w).toFixed(2);
  hInp.value     = inch(selected.h).toFixed(2);
  colInp.value   = selected.color;
  alphaInp.value = selected.alpha;
}

function applyChanges(){
  if(!selected) return;
  selected.label = nameInp.value.trim() || 'Unnamed';
  selected.w     = parseFloat(wInp.value||0) * SCALE;
  selected.h     = parseFloat(hInp.value||0) * SCALE;
  selected.color = colInp.value;
  selected.alpha = parseFloat(alphaInp.value);
  draw(); refreshList();
}
[nameInp,wInp,hInp,colInp,alphaInp].forEach(inp=> inp.oninput = applyChanges);

document.getElementById('delObj').onclick = () => {
  if(!selected) return;
  items = items.filter(it=> it!==selected);
  selected = null;
  refreshList(); updateEditor(); draw();
};

document.getElementById('addObj').onclick = () => {
  const base = make('New',12,12,UNIT_W/2,CLOSET_H_PX + UNIT_H/2,'#a7f3d0');
  base.alpha = 0.8;
  items.push(base);
  selected = base;
  refreshList(); updateEditor(); draw();
};

/***** ── Drag & hit‑testing ── *****/
function hit(it,px,py){
  const cx = it.x + it.w/2, cy = it.y + it.h/2;
  const dx = px - cx, dy = py - cy;
  const rad = -it.angle * Math.PI / 180;
  const rx = dx*Math.cos(rad) - dy*Math.sin(rad);
  const ry = dx*Math.sin(rad) + dy*Math.cos(rad);
  return rx > -it.w/2 && rx < it.w/2 && ry > -it.h/2 && ry < it.h/2;
}

canvas.addEventListener('pointerdown',e=>{
  const rect = canvas.getBoundingClientRect();
  const px = e.clientX - rect.left;
  const py = e.clientY - rect.top;
  selected = null;
  for(let i=items.length-1;i>=0;i--){
    if(hit(items[i],px,py)){
      selected = items[i];
      offX = px - (selected.x + selected.w/2);
      offY = py - (selected.y + selected.h/2);
      drag = true;
      break;
    }
  }
  refreshList(); updateEditor(); draw();
});

canvas.addEventListener('pointermove',e=>{
  if(!drag || !selected) return;
  const rect = canvas.getBoundingClientRect();
  let nx = e.clientX - rect.left - selected.w/2 - offX;
  let ny = e.clientY - rect.top  - selected.h/2 - offY;

  const {w:horiz, h:vert} = dims(selected);
  const minY = 0, maxY = CANVAS_H - vert;
  let   minX = 0, maxX = UNIT_W - horiz;
  if(ny < CLOSET_H_PX){ maxX = CLOSET_W_PX - horiz; }

  selected.x = Math.min(Math.max(nx, minX), maxX);
  selected.y = Math.min(Math.max(ny, minY), maxY);
  draw();
});
window.addEventListener('pointerup',()=> drag = false);

/***** ── Save / Load ── *****/
const savePng     = document.getElementById('savePng');
const saveLayout  = document.getElementById('saveLayout');
const loadLayout  = document.getElementById('loadLayout');
const fileInput   = document.getElementById('fileInput');

savePng.onclick = ()=>{
  const a = document.createElement('a');
  a.download = 'bedroom-layout.png';
  a.href = canvas.toDataURL('image/png');
  a.click();
};

saveLayout.onclick = ()=>{
  const json = JSON.stringify(items.map(it=>({
    label:it.label,
    width_in:inch(it.w),
    height_in:inch(it.h),
    x_in:inch(it.x),
    y_in:inch(it.y),
    color:it.color,
    angle:it.angle,
    alpha:it.alpha
  })),null,2);
  const blob = new Blob([json],{type:'application/json'});
  const url  = URL.createObjectURL(blob);
  const a    = document.createElement('a');
  a.href = url; a.download = 'bedroom-layout.json'; a.click();
  URL.revokeObjectURL(url);
};

loadLayout.onclick = ()=> fileInput.click();
fileInput.onchange = e =>{
  const file = e.target.files[0];
  if(!file) return;
  const reader = new FileReader();
  reader.onload = evt => {
    let arr;
    try {
      arr = JSON.parse(evt.target.result);
      if(!Array.isArray(arr)) throw new Error('Root is not array');
    } catch(err){
      alert('Invalid layout file – please choose a JSON created via “Save Layout”.');
      return;
    }

    items = arr.map(o=> make(
      o.label || 'Item',
      +o.width_in   || 12,
      +o.height_in  || 12,
      (+o.x_in || 0)*SCALE,
      (+o.y_in || 0)*SCALE,
      o.color || '#ddd'
    ));
    items.forEach((it,i)=>{
      it.angle = +arr[i].angle || 0;
      it.alpha = arr[i].alpha ?? 1;
    });

    selected = null;
    refreshList(); updateEditor(); draw();
  };
  reader.readAsText(file);
  fileInput.value = '';
};

/***** ── Kick everything off ── *****/
refreshList(); draw();
</script>
</body>
</html>
